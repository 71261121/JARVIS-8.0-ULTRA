// JARVIS 8.0 ULTRA - Complete Database Schema
// Loyola Academy B.Sc CS Entrance Exam Preparation System
// Item Response Theory + Spaced Repetition + Psychological Engine

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String
  targetExam        String   @default("Loyola Academy B.Sc CS Entrance")
  examDate          DateTime?
  startDate         DateTime @default(now())
  currentPhase       Int      @default(1) // 1-4 phases
  
  // IRT Ability Parameters (per subject)
  mathsTheta        Float    @default(0.0)   // Mathematics ability (-3 to +3)
  physicsTheta      Float    @default(0.0)   // Physics ability
  chemistryTheta    Float    @default(0.0)   // Chemistry ability
  englishTheta      Float    @default(0.0)   // English ability
  
  // Psychological Engine
  totalXP           Int      @default(0)
  currentStreak     Int      @default(0)
  longestStreak     Int      @default(0)
  focusCoins        Int      @default(100)   // Virtual currency
  level             Int      @default(1)
  rank              Int      @default(0)     // Leaderboard rank
  
  // Study Statistics
  totalStudyMinutes Int      @default(0)
  totalQuestions    Int      @default(0)
  correctAnswers    Int      @default(0)
  totalSessions     Int      @default(0)
  averageSpeed      Float    @default(0.0)   // Seconds per question
  
  // Settings
  dailyStudyHours   Int      @default(8)
  wakeUpTime        String   @default("05:00")
  sleepTime         String   @default("21:00")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt()
  
  // Relations
  sessions          Session[]
  questionResponses QuestionResponse[]
  topicMastery      TopicMastery[]
  spacedReviews     SpacedReview[]
  interviewSessions InterviewSession[]
  achievements      UserAchievement[]
  distractionEvents DistractionEvent[]
  dailyPlans        DailyPlan[]
  mockTests         MockTest[]
  analyticsRecords  AnalyticsRecord[]
}

// ============================================
// QUESTION BANK SYSTEM
// ============================================

model Subject {
  id          String    @id @default(cuid())
  name        String    @unique  // Mathematics, Physics, Chemistry, English
  code        String    @unique  // maths, physics, chemistry, english
  totalMarks  Int       @default(0)  // Weight in exam
  priority    Int       @default(1)  // 1 = highest
  
  topics      Topic[]
  questions   Question[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt()
}

model Topic {
  id              String    @id @default(cuid())
  subjectId       String
  name            String
  code            String    // e.g., "matrices", "calculus"
  description     String?
  
  // IRT Parameters for topic
  difficulty      Float     @default(0.0)  // Average difficulty (-3 to +3)
  importance      Float     @default(0.5)  // Weight in exam (0-1)
  frequency       Float     @default(0.0)  // How often appears (verified from papers)
  
  // Hierarchy
  parentId        String?
  parent          Topic?    @relation("TopicHierarchy", fields: [parentId], references: [id])
  subTopics       Topic[]   @relation("TopicHierarchy")
  
  questions       Question[]
  masteryRecords  TopicMastery[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt()
  
  subject         Subject   @relation(fields: [subjectId], references: [id])
  
  @@unique([subjectId, code])
}

model Question {
  id              String    @id @default(cuid())
  topicId         String
  subjectId       String
  
  // Question Content
  questionText    String
  optionA         String
  optionB         String
  optionC         String?
  optionD         String?
  correctAnswer   String    // "A", "B", "C", or "D"
  explanation     String?
  
  // IRT Parameters (Item Response Theory)
  difficulty      Float     @default(0.0)   // b parameter (-3 to +3)
  discrimination  Float     @default(1.0)   // a parameter (0.5 to 2.5)
  guessing        Float     @default(0.25)  // c parameter (0 to 0.5)
  
  // Metadata
  source          String?   // "previous_year", "generated", "manual"
  year            Int?      // If previous year question
  verified        Boolean   @default(false)
  timesAsked      Int       @default(0)
  timesCorrect    Int       @default(0)
  
  // For Adaptive Testing
  isActive        Boolean   @default(true)
  
  responses       QuestionResponse[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt()
  
  topic           Topic     @relation(fields: [topicId], references: [id])
  subject         Subject   @relation(fields: [subjectId], references: [id])
}

// ============================================
// SESSION & PROGRESS TRACKING
// ============================================

model Session {
  id              String    @id @default(cuid())
  userId          String
  
  // Session Info
  sessionType     String    // "study", "practice", "mock_test", "interview"
  startTime       DateTime  @default(now())
  endTime         DateTime?
  durationMinutes Int       @default(0)
  
  // Subject/Topic Focus
  subjectFocus    String?   // Primary subject studied
  topicFocus      String?   // Primary topic studied
  
  // Performance
  questionsAttempted Int    @default(0)
  questionsCorrect    Int   @default(0)
  averageTimePerQ     Float @default(0.0)
  
  // XP and Rewards
  xpEarned        Int       @default(0)
  coinsEarned     Int       @default(0)
  coinsLost       Int       @default(0)
  
  // Distraction Tracking
  distractions    Int       @default(0)
  focusScore      Float     @default(100.0)  // 0-100
  
  // Notes
  notes           String?
  
  user            User      @relation(fields: [userId], references: [id])
  responses       QuestionResponse[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt()
}

model QuestionResponse {
  id              String    @id @default(cuid())
  userId          String
  questionId      String
  sessionId       String?
  
  // Response
  selectedAnswer  String
  isCorrect       Boolean
  timeTakenMs     Int       // Time to answer in milliseconds
  
  // IRT Update
  thetaBefore     Float     // User's theta before this question
  thetaAfter      Float     // User's theta after this question
  thetaChange     Float     // How much theta changed
  
  // Spaced Repetition
  nextReview      DateTime?
  reviewInterval  Int       @default(0)  // Days until next review
  
  // Context
  responseContext String?   // "practice", "mock_test", "spaced_review"
  
  user            User      @relation(fields: [userId], references: [id])
  question        Question  @relation(fields: [questionId], references: [id])
  session         Session?  @relation(fields: [sessionId], references: [id])
  
  createdAt       DateTime  @default(now())
  
  @@index([userId, questionId])
  @@index([userId, createdAt])
}

// ============================================
// TOPIC MASTERY & SPACED REPETITION
// ============================================

model TopicMastery {
  id              String    @id @default(cuid())
  userId          String
  topicId         String
  
  // Mastery Level (0-100)
  masteryLevel    Float     @default(0.0)
  confidenceScore Float     @default(0.0)
  
  // IRT Theta for this topic
  topicTheta      Float     @default(0.0)
  
  // Spaced Repetition
  nextReview      DateTime?
  reviewCount     Int       @default(0)
  correctStreak   Int       @default(0)
  incorrectStreak Int       @default(0)
  
  // Performance Stats
  totalQuestions  Int       @default(0)
  correctQuestions Int      @default(0)
  
  // Last Performance
  lastCorrect     Boolean?
  lastAttemptAt   DateTime?
  
  user            User      @relation(fields: [userId], references: [id])
  topic           Topic     @relation(fields: [topicId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt()
  
  @@unique([userId, topicId])
}

model SpacedReview {
  id              String    @id @default(cuid())
  userId          String
  topicId         String?
  questionId      String?
  
  // SM-2 Algorithm Parameters
  easeFactor      Float     @default(2.5)   // Difficulty adjustment
  interval        Int       @default(0)     // Days until next review
  repetitions     Int       @default(0)     // Consecutive correct answers
  
  // Scheduling
  nextReviewDate  DateTime
  lastReviewDate  DateTime?
  
  // Status
  status          String    @default("pending")  // "pending", "completed", "skipped"
  quality         Int?      // 0-5 rating (SM-2 quality)
  
  user            User      @relation(fields: [userId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt()
}

// ============================================
// INTERVIEW PREPARATION
// ============================================

model InterviewSession {
  id              String    @id @default(cuid())
  userId          String
  
  // Session Info
  sessionType     String    // "mock_interview", "communication", "cs_basics"
  startTime       DateTime  @default(now())
  endTime         DateTime?
  durationMinutes Int       @default(0)
  
  // Performance
  questionsAsked  Int       @default(0)
  confidenceScore Float     @default(0.0)
  clarityScore    Float     @default(0.0)
  technicalScore  Float     @default(0.0)
  
  // Feedback
  strengths       String?   // JSON array of strengths
  weaknesses      String?   // JSON array of weaknesses
  recommendations String?   // JSON array of recommendations
  
  // Notes
  notes           String?
  
  user            User      @relation(fields: [userId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt()
}

model InterviewQuestion {
  id              String    @id @default(cuid())
  category        String    // "personal", "academic", "cs_basics", "current_affairs", "situational"
  question        String
  modelAnswer     String?
  keywords        String?   // JSON array of key points
  difficulty      Int       @default(1)  // 1-5
  
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt()
}

// ============================================
// PSYCHOLOGICAL ENGINE
// ============================================

model Achievement {
  id              String    @id @default(cuid())
  code            String    @unique  // "first_session", "streak_7", "perfect_score"
  name            String
  description     String
  icon            String?   // Emoji or icon name
  xpReward        Int       @default(0)
  coinReward      Int       @default(0)
  
  // Unlock Condition
  conditionType   String    // "streak", "xp", "questions", "accuracy", "time"
  conditionValue  Int
  
  isSecret        Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt()
}

model UserAchievement {
  id              String    @id @default(cuid())
  userId          String
  achievementId   String
  
  unlockedAt      DateTime  @default(now())
  
  user            User      @relation(fields: [userId], references: [id])
  
  @@unique([userId, achievementId])
}

model Leaderboard {
  id              String    @id @default(cuid())
  userId          String
  period          String    // "daily", "weekly", "monthly", "all_time"
  
  rank            Int
  xp              Int
  questionsAnswered Int
  accuracy        Float
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt()
}

// ============================================
// ROOT COMMANDS & DISTRACTION TRACKING
// ============================================

model DistractionEvent {
  id              String    @id @default(cuid())
  userId          String
  
  // App Info
  packageName     String    // e.g., "com.instagram.android"
  appName         String
  category        String    // "social", "gaming", "entertainment", "other"
  
  // Timing
  detectedAt      DateTime  @default(now())
  durationSec     Int       @default(0)
  
  // Action Taken
  action          String?   // "warned", "force_stopped", "blocked_network"
  
  // Context
  sessionId       String?
  wasStudyTime    Boolean   @default(true)
  
  user            User      @relation(fields: [userId], references: [id])
  
  createdAt       DateTime  @default(now())
}

model RootCommandLog {
  id              String    @id @default(cuid())
  command         String
  result          String?   // "success", "failed", "error"
  output          String?
  errorMessage    String?
  
  executedAt      DateTime  @default(now())
}

// ============================================
// 90-DAY PLAN
// ============================================

model DailyPlan {
  id              String    @id @default(cuid())
  userId          String
  dayNumber       Int       // 1-90
  
  // Schedule
  date            DateTime
  phase           Int       // 1-4
  
  // Planned Activities
  mathsTopics     String?   // JSON array of topic IDs
  physicsTopics   String?
  chemistryTopics String?
  englishTopics   String?
  
  // Targets
  targetHours     Float     @default(8.0)
  targetQuestions Int       @default(50)
  
  // Actuals
  actualHours     Float     @default(0.0)
  actualQuestions Int       @default(0)
  
  // Status
  isCompleted     Boolean   @default(false)
  completionPct   Float     @default(0.0)
  
  // Notes
  notes           String?
  
  user            User      @relation(fields: [userId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt()
  
  @@unique([userId, dayNumber])
}

// ============================================
// MOCK TESTS
// ============================================

model MockTest {
  id              String    @id @default(cuid())
  userId          String
  
  // Test Info
  testType        String    // "full_test", "subject_test", "topic_test"
  testDate        DateTime  @default(now())
  
  // Scores
  mathsScore      Int       @default(0)
  physicsScore    Int       @default(0)
  chemistryScore  Int       @default(0)
  englishScore    Int       @default(0)
  totalScore      Int       @default(0)
  maxScore        Int       @default(50)
  
  // Time
  totalTimeMin    Int       @default(50)
  timeTakenMin    Int       @default(0)
  
  // Analysis
  accuracy        Float     @default(0.0)
  avgTimePerQ     Float     @default(0.0)
  
  // IRT Analysis
  estimatedTheta  Float     @default(0.0)
  
  // Feedback
  strengths       String?   // JSON array
  weaknesses      String?   // JSON array
  recommendations String?   // JSON array
  
  user            User      @relation(fields: [userId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt()
}

// ============================================
// ANALYTICS & REPORTING
// ============================================

model AnalyticsRecord {
  id              String    @id @default(cuid())
  userId          String
  
  // Time Period
  date            DateTime  @default(now())
  period          String    // "daily", "weekly", "monthly"
  
  // Study Metrics
  totalMinutes    Int       @default(0)
  sessionsCount   Int       @default(0)
  questionsAnswered Int     @default(0)
  correctAnswers  Int       @default(0)
  
  // Subject Breakdown (JSON)
  subjectStats    String?   // JSON object with per-subject stats
  
  // Performance
  averageAccuracy Float     @default(0.0)
  averageSpeed    Float     @default(0.0)
  focusScore      Float     @default(0.0)
  
  // IRT Progress
  thetaProgress   String?   // JSON with theta changes per subject
  
  // Streaks & XP
  streakDays      Int       @default(0)
  xpEarned        Int       @default(0)
  
  user            User      @relation(fields: [userId], references: [id])
  
  createdAt       DateTime  @default(now())
  
  @@index([userId, date])
}
